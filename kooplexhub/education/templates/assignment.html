{% extends "education_layout.html" %}

{% load render_table from django_tables2 %}
{% load static %}
{% load extras %}


{% block head_content %}
<!-- datetime picker requirements -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js"
      crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/Eonasdan/tempus-dominus@master/dist/js/tempus-dominus.js"
      crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/gh/Eonasdan/tempus-dominus@master/dist/css/tempus-dominus.css"
      rel="stylesheet" crossorigin="anonymous">

<!-- bootstrap-toggler requirement -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/css/bootstrap5-toggle.min.css" rel="stylesheet">
<style>
  .mytab{
    color: rgb(196, 196, 196);
  }
  .mytab:hover{
    color: rgb(196, 196, 196);
    font-weight: bolder;
  }
  .mytab.active {
    font-weight: bolder;
  }
</style>
{% endblock %}


{% block realcontent %}
<ul class="nav nav-tabs  mb-2 mt-3" id="assignmentTeacherTabs" role="tablist">
  <li class="nav-item" role="presentation" data-intro="#newassignmentarea">
    {% if active == "new" %}
    <a class="nav-link mytab active" id="tab-new" href="#" type="button" role="tab" aria-controls="newAssignment" aria-selected="true">New Assignment</a>
    {% else %}
    <a class="nav-link mytab" id="tab-new" href="{% url 'education:assignment_new' %}" type="button" role="tab" aria-controls="newAssignment" aria-selected="false">New Assignment</a>
    {% endif %}
  </li>
  <li class="nav-item" role="presentation" data-intro="#configureassignmentarea">
    {% if active == "conf" %}
    <a class="nav-link mytab active" id="tab-conf" href="#" type="button" role="tab" aria-controls="confAssignment" aria-selected="true">Configure Assignment</a>
    {% else %}
    <a class="nav-link mytab" id="tab-conf" href="{% url 'education:assignment_configure' %}" type="button" role="tab" aria-controls="confAssignment" aria-selected="false">Configure Assignment</a>
    {% endif %}
  </li>
  <li class="nav-item" role="presentation" data-intro="#massassignmentarea">
    {% if active == "handlemass" %}
    <a class="nav-link mytab active" id="tab-handlemass" href="#" type="button" role="tab" aria-controls="AssignmentMass" aria-selected="true">Mass Assignments</a>
    {% else %}
    <a class="nav-link mytab" id="tab-handlemass" href="{% url 'education:assignment_handle_mass' %}" type="button" role="tab" aria-controls="AssignmentMass" aria-selected="false">Mass Assignments</a>
    {% endif %}
  </li>
  <li class="nav-item" role="presentation" data-intro="#handleassignmentarea">
    {% if active == "handle" %}
    <a class="nav-link mytab active" id="tab-handle" href="#" type="button" role="tab" aria-controls="Assignment" aria-selected="true">Handle Assignments</a>
    {% else %}
    <a class="nav-link mytab" id="tab-handle" href="{% url 'education:assignment_handle' %}" type="button" role="tab" aria-controls="Assignment" aria-selected="false">Handle Assignments</a>
    {% endif %}
  </li>
  <li class="nav-item" role="presentation" data-intro="#summaryofcoursesarea">
    {% if active == "summary" %}
    <a class="nav-link mytab active" id="tab-summary" href="#" type="button" role="tab" aria-controls="summary" aria-selected="true">Student points</a>
    {% else %}
    <a class="nav-link mytab" id="tab-summary" href="{% url 'education:assignment_summary' %}" type="button" role="tab" aria-controls="summary" aria-selected="false">Student points</a>
    {% endif %}
  </li>
</ul>

<div class="tab-content {#mb-2 mt-2#}" id="assignmentTeacherTabContent">
  {% block assignment_content %}
  <div class="tab-pane fade {% if active == "summary" %}show active{% endif %}" id="summary" role="tabpanel" aria-labelledby="tab-summary">
    {% if d_course_assignments|length > 0 %}
    <div class="d-flex flex-row mb-2 mt-2">
      <div class="p-2 mt-1">
        <span data-toggle="tooltip" title="Select assignment you'd like to handle"><i class="bi bi-journal-bookmark-fill"></i>&nbsp;Course</span>
      </div>
      <div class="p-2 flex-fill">
        <select class="form-select" id="summary_course_selected" name="summary_course_selected">
              <optgroup label="-- Select course --"></optgroup>
              {% for c_id, ass in d_course_assignments.items %}
                {% with ass|first as a0 %}
                <option value="{{ a0.course.id }}"> 
                {{ a0.course.name }}
                </option>               
                 {% endwith %}
              {% endfor %}
        </select>
      </div>
    </div>
    {% else %}
        {% include 'empty.html' with empty_body='You have not filled in the scores for your assignments.' skip_border=True %}
    {% endif %}
    <form id='student-grade' class="mb-3 mt-3">
      <input type="hidden" name="assignment" value="{{assignment_id}}" >
      {% for c_id, t in  t_summary.items %}
      <div id="st-{{c_id}}">
        {{ t }}
      </div>
      {% endfor %}
    </form>
  </div>
  {% endblock %}
</div>
{% endblock %}

{% block scripts %}
<script>
$("#assignmentTeacherTabs li a").on("click", function () {
  var tab = $( this ).attr("id").split('-')[1]
  console.log( tab )
  $.cookie("assignment_teacher_tab", tab, { 'path': '/', 'secure': true });
});
$("#assignment_selected").change(function() {
  var sel_id = $( this ).val();
  console.log( "changed to " + sel_id );
  $('[id^=operationPanelMass-]').each(function() {
    var myid = $(this).attr("id").split('-')[1]
    console.log( "checking " + myid );
    if ( myid == sel_id ) {
      $( this ).show();
    } else {
      $( this).hide();
    }
  });
  $('[id^=operationPanelIndividual-]').each(function() {
    var myid = $(this).attr("id").split('-')[1]
    console.log( "checking " + myid );
    if ( myid == sel_id ) {
      $( this ).show();
    } else {
      $( this).hide();
    }
  });
}).change();
$("#summary_course_selected").change(function() {
  var sel_id = $( this ).val();
  console.log( "summary course changed to " + sel_id );
  $('[id^=st-]').each(function() {
    var myid = $(this).attr("id").split('-')[1]
    console.log( "checking " + myid );
    if (myid == sel_id) {
      $( this ).show();
    } else {
      $( this ).hide();
    }
  });
}).change();
$("#course_selected").change(function () {
  var old = $( "#course_id" ).val();
  var sel;
  $( "#course_selected>option:selected" ).each(function() {
    sel = $( this ).val();
    $( "#course_id" ).val( sel );
  });
  if (old) {
    $( "#newAssignmentForm-" + old ).hide();
    $( "#newAssignmentForm-" + old ).find('input').each(function() {
      $( this ).prop( "disabled", true );
    });
    $( "#newAssignmentForm-" + old ).find('textarea').each(function() {
      $( this ).prop( "disabled", true );
    });
    $( "#newAssignmentForm-" + old ).find('select').each(function() {
      $( this ).prop( "disabled", true );
    });
  } else {
    $('[id^=newAssignmentForm-]').each(function() {
      $( this ).find('input').each(function() {
        $( this ).prop( "disabled", true );
      });
      $( this ).find('textarea').each(function() {
        $( this ).prop( "disabled", true );
      });
      $( this ).find('select').each(function() {
        $( this ).prop( "disabled", true );
      });
    });
  }
  $( "#newAssignmentForm-" + sel ).show();
  $( "#newAssignmentForm-" + sel ).find('input').each(function() {
    $( this ).prop( "disabled", false );
  });
  $( "#newAssignmentForm-" + sel ).find('textarea').each(function() {
    $( this ).prop( "disabled", false );
  });
  $( "#newAssignmentForm-" + sel ).find('select').each(function() {
    $( this ).prop( "disabled", false );
  });
  console.log( "chg: " + old + " -> " + sel );
}).change();



$("#search_student").keyup(function() {
  var pattern = $( this ).val().toUpperCase();
  console.log( "search student: " + pattern );
  $( "#assignment-form-individual" ).find('tr').each(function() {
    if ( $( this ).parent().is("thead") ) {
      return;
    }
    var hide_it = true;
    if (pattern.length > 0) {
      $( this ).find("input[name='search_student'").each(function() {
        var name = $( this ).val().toUpperCase();
        if ( name.indexOf(pattern) > -1 ) {
	  hide_it = false;
        }
      });
    } else {
      hide_it = false;
    }
    if (hide_it) {
      $( this ).hide();
    } else {
      $( this ).show();
    }
  });
});

$("input[id^='score-'").on("change", function() {
  var old = $("#old_" + $(this).attr("id"))
  console.log( $( this ).val() )
  if ( $( this ).val() != old.val() ) {
    var cb = $("#uab-" + $(this).attr("id").split('-')[1])
    if (cb.attr("name") == "selection_finalize") {
      cb.prop('checked', true) 
    }
  }
});
$("textarea[id^='feedback_text-'").on("change", function() {
  var old = $("#old_" + $(this).attr("id"))
  console.log( $( this ).val() )
  if ( $( this ).val() != old.val() ) {
    var cb = $("#uab-" + $(this).attr("id").split('-')[1])
    if (cb.attr("name") == "selection_finalize") {
      cb.prop('checked', true) 
    }
  }
});

// loop over all linked datetime picker widgets
document.querySelectorAll('[id^="linkedPickers1-"]').forEach(function(linkedPicker1Element) {
  const linked1 = new tempusDominus.TempusDominus(linkedPicker1Element, {
        display: {
            icons: {
                time: 'bi bi-clock',
                date: 'bi bi-calendar',
                up: 'bi bi-arrow-up',
                down: 'bi bi-arrow-down',
                previous: 'bi bi-chevron-left',
                next: 'bi bi-chevron-right',
                today: 'bi bi-calendar-check',
                clear: 'bi bi-trash',
                close: 'bi bi-x'
            },
            buttons: {
                today: true,
                clear: true,
                close: true
            }
        }
    });
  const id_other = linkedPicker1Element.id.replace('linkedPickers1-', 'linkedPickers2-');
  const linked2 = new tempusDominus.TempusDominus(document.getElementById(id_other), {
        useCurrent: false,
        display: {
            icons: {
                time: 'bi bi-clock',
                date: 'bi bi-calendar',
                up: 'bi bi-arrow-up',
                down: 'bi bi-arrow-down',
                previous: 'bi bi-chevron-left',
                next: 'bi bi-chevron-right',
                today: 'bi bi-calendar-check',
                clear: 'bi bi-trash',
                close: 'bi bi-x'
            },
            buttons: {
                today: true,
                clear: true,
                close: true
            }
        }
    });
  
    //using event listeners
  linkedPicker1Element.addEventListener(tempusDominus.Namespace.events.change, (e) => {
        linked2.updateOptions({
            restrictions: {
                minDate: e.detail.date
            }
        });
  });
  
    //using subscribe method
  const subscription = linked2.subscribe(tempusDominus.Namespace.events.change, (e) => {
        linked1.updateOptions({
            restrictions: {
                maxDate: e.date
            }
        });
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap5-toggle@3.7.0/js/bootstrap5-toggle.min.js"></script>
{% endblock %}
