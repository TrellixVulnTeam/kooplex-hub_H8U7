{% extends "layout.html" %}
{% load render_table from django_tables2 %}

{% load static %}

{% block css_extra %}
    <link rel="stylesheet" type="text/css" href="{% static 'bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css' %}">
{% endblock %}


{% block submenu %}
{% include 'education_submenu.html' with title="Education" submenu="assignment" %}
{% endblock %}


{% block chardinhelp %}
<link type="text/css" href="{% static 'chardinjs/chardinjs.css' %}" rel="stylesheet">
<script src="{% static 'chardinjs/chardinjs.js' %}" type="text/javascript"></script>
<script>
   (function() {
     $(function() {
       $('body').chardinJs({
         'attribute': 'data-intro',
         url: "{% static 'chardinjs/help_assignment.json' %}"
       });
   
       // or trigger via an anchor tag
       $('a[data-toggle="chardinjs"]').on('click', function (e) {
         e.preventDefault();
         $("div.envcard:first").find(".collapse").addClass('show');
         return ($('body').data('chardinJs')).toggle();
       });
   
         return $('body').on('chardinJs:stop', function () {
         //$("div.envcard:first").find(".collapse").removeClass('show');

       });

     });
   }).call(this);
</script>
{% endblock %}



{% block main_content_right %}

<ul class="nav nav-tabs  mb-2 mt-3" id="assignmentTeacherTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == "tab-new" %}active{% endif %}" id="tab-new" data-bs-toggle="tab" data-bs-target="#newAssignment" type="button" role="tab" aria-controls="newAssignment" aria-selected="{% if active_tab == "tab-new" %}true{% else %}false{% endif %}">New Assignment</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == "tab-conf" %}active{% endif %}" id="tab-conf" data-bs-toggle="tab" data-bs-target="#confAssignment" type="button" role="tab" aria-controls="confAssignment" aria-selected="{% if active_tab == "tab-conf" %}true{% else %}false{% endif %}">Configure Assignment</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == "tab-handlemass" %}active{% endif %}" id="tab-handlemass" data-bs-toggle="tab" data-bs-target="#AssignmentMass" type="button" role="tab" aria-controls="AssignmentMass" aria-selected="{% if active_tab == "tab-handlemass" %}true{% else %}false{% endif %}">Mass Assignments</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == "tab-handle" %}active{% endif %}" id="tab-handle" data-bs-toggle="tab" data-bs-target="#Assignment" type="button" role="tab" aria-controls="Assignment" aria-selected="{% if active_tab == "tab-handle" %}true{% else %}false{% endif %}">Handle Assignments</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link {% if active_tab == "tab-summary" %}active{% endif %}" id="tab-summary" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="{% if active_tab == "tab-summary" %}true{% else %}false{% endif %}">Assignment Summary</button>
  </li>
</ul>

<div class="tab-content {#mb-2 mt-2#}" id="assignmentTeacherTabContent">
  {# New #}
  <div class="tab-pane fade {% if active_tab == "tab-new" %}show active{% endif %}" id="newAssignment" role="tabpanel" aria-labelledby="tab-new">
    <div class="card shadow mt-3 p-3 mb-2 bg-light rounded">
      {% if f_assignment|length > 0 %}
      <form id="assignments-form-new" class="form-horizontal" action="{% url 'education:newassignment' %}" method="post">
        {% csrf_token %}
	<input type="hidden" name="course_id" id="course_id" value="">
        <table>
	  <thead>
	    <tr>
	      <th><label class="mt-2" for="course_selected">Selected course: </label></th>
	      <td>
                <select id="course_selected" name="course_selected" class="form-select" style="width: 100%">
	          {% for f in f_assignment %}
	            {% if f.okay %}
	            <option value="{{ f.course.id }}">{{ f.course }}</option>
	            {% endif %}
                  {% endfor %}
                </select>
	      </td>
	    </tr>
	  </thead>
	  {% for f in f_assignment %}
	    {% if f.okay %}
	    <tbody style="display: none" id="newAssignmentForm-{{ f.course.id }}">
                {{ f.as_table }}
            </tbody>
	    {% endif %}
          {% endfor %}
        </table>
        {% include 'apply_cancel.html' with hide_cancel=True %}
      </form>
      {% else %}
      <div class="alert alert-warning">There are no candidate subfolders in <code>assignment_prepare</code> directory. Please create one and place all files into it to be part of a new assignment. Empty folders cannot be selected.</div>
      {% endif %}
    </div>
  </div>

  {# Configure #}
  <div class="tab-pane fade {% if active_tab == "tab-conf" %}show active{% endif %}" id="confAssignment" role="tabpanel" aria-labelledby="tab-conf">
    <div class="mt-3">
      <h4 style="margin-bottom: 0px;">Delete or refresh assignments</h4>
      {% if t_assignment_config.data|length > 0 %}
      {%endif %}
      <form id='assignment-form-configure' class="mt-3" action="{% url 'education:configureassignment' %}" method="post">
        {% csrf_token %}
        <input data-intro="#configureassignmentsearch" class="form-control mb-3" style="margin-top: -10px;" type="text" id="search_configure" placeholder="Search course or assignment" title="Type in a name" autofocus>
        <div data-intro="#configureassignmentarea">
        {% render_table t_assignment_config %}
        {% if t_assignment_config.data|length > 0 %}
          {% include 'apply_cancel.html' with hide_cancel=True %}
        {%endif %}
      </div>
      </form>
    </div>
  </div>

  {# Mass Assignments #}
  <div class="tab-pane fade {% if active_tab == "tab-handlemass" %}show active{% endif %}" id="AssignmentMass" role="tabpanel" aria-labelledby="tab-handlemass">
    <div class="mt-3">
      <h5>Mass operation</h5>
      {% if t_mass_all %}
        <form id='assignment-form-mass-all' class="row mb-3 mt-3" action="{% url 'education:handle_mass_many' %}" method="post">
          {% csrf_token %}
          {% render_table t_mass_all %}
          <div style="justify-content: end;">
            {% include 'apply_cancel.html' with hide_cancel=True %}
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning">You do not hane any assignments defined yet.</div>
      {% endif %}
    </div>
  </div>

  {# Handle Assignments #}
  <div class="tab-pane fade {% if active_tab == "tab-handle" %}show active{% endif %}" id="Assignment" role="tabpanel" aria-labelledby="tab-handle">
    <div class="mt-3">
      {% if d_course_assignments|length > 0 %}
        <h4 style="margin-bottom: 0px;">Select an assignment to handle</h4>
        <form id='assignment-form-handle' style="margin-top: -8px;" class="mt-1 mb-4" action="{% url 'education:assignment_teacher' %}" method="post">
          {% csrf_token %}
          <div class="mb-2 mt-2">
            <select class="form-select" id="assignment_selected" name="assignment_selected" autofocus>
              {% for c_id, ass in d_course_assignments.items %}
                {% with ass|first as a0 %}
                <optgroup label="{{ a0.course.name }} ({{ a0.course.folder }})"> 
                {% endwith %}
                {% for a in ass %}
                  <option class="dropdown-item" value="{{ a.id }}"
                    {% if a.id == assignment_id %} selected {% endif %}
                  >{{ a.name }} ({{ a.folder }})</option>
                {% endfor %}
                </optgroup>
              {% endfor %}
            </select>
            <div style="display: none" id="operationPanelRefresh" class="alert alert-warning">
              <h6>Refresh</h6>
              <p>You selected a different assignment than the previous. Please use the Filter button to refresh the content. Any unapplied changes will be lost.</p>
              <input type="submit" class="btn btn-primary ml-2" value="Filter">
            </div>
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning">You need to define an assignment before you can handle them.</div>
      {% endif %}
      <div id="operationPanel">
      {% if assignment_id %}
        <h5>Mass operation</h5>
        <form id='assignment-form-mass' class="row mb-3 mt-3" action="{% url 'education:handle_mass' %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="assignment" value="{{assignment_id}}" id="assignment_id">
          {% render_table t_mass %}
          <div style="justify-content: end;">
          {% include 'apply_cancel.html' with hide_cancel=True %}
        </div>
        </form>
        <div class="mt-4">
          <h5>Individual operation</h5>
        </div>
        <input class="form-control me-2 mb-3 mt-3" type="text" id="search_student" placeholder="Search student by name or username" title="Type in a name">
        <form  id='assignment-form-individual' class="mb-3 mt-3" action="{% url 'education:handleassigment' %}" method="post">
          {% csrf_token %}
          <input type="hidden" name="assignment" value="{{assignment_id}}" >
          {% render_table t_assignments %}
          {% include 'apply_cancel.html' with hide_cancel=True %}
        </form>
      {% endif %}
      </div>
    </div>
  </div>

  {# Summary #}
  <div class="tab-pane fade {% if active_tab == "tab-summary" %}show active{% endif %}" id="summary" role="tabpanel" aria-labelledby="tab-summary">
    <h4 class="mt-3">Summary</h4>
    {% if t_assignment_summary %}
      {% render_table t_assignment_summary %}
    {% else %}
      missing table assignment summary
    {% endif %}
  </div>
</div>





<script>
$("#assignmentTeacherTabs>li>button").on("click", function () {
  var tab = $( this ).attr("id");
  $.cookie("active_tab", tab, { 'path': '/', 'secure': true });
  console.log( "tab: " + tab );
});

$("#course_selected").change(function () {
  var old = $( "#course_id" ).val();
  var sel;
  $( "#course_selected>option:selected" ).each(function() {
    sel = $( this ).val();
    $( "#course_id" ).val( sel );
  });
  if (old) {
    $( "#newAssignmentForm-" + old ).hide();
    $( "#newAssignmentForm-" + old ).find('input').each(function() {
      $( this ).prop( "disabled", true );
    });
    $( "#newAssignmentForm-" + old ).find('textarea').each(function() {
      $( this ).prop( "disabled", true );
    });
    $( "#newAssignmentForm-" + old ).find('select').each(function() {
      $( this ).prop( "disabled", true );
    });
  } else {
    $('[id^=newAssignmentForm-]').each(function() {
      $( this ).find('input').each(function() {
        $( this ).prop( "disabled", true );
      });
      $( this ).find('textarea').each(function() {
        $( this ).prop( "disabled", true );
      });
      $( this ).find('select').each(function() {
        $( this ).prop( "disabled", true );
      });
    });
  }
  $( "#newAssignmentForm-" + sel ).show();
  $( "#newAssignmentForm-" + sel ).find('input').each(function() {
    $( this ).prop( "disabled", false );
  });
  $( "#newAssignmentForm-" + sel ).find('textarea').each(function() {
    $( this ).prop( "disabled", false );
  });
  $( "#newAssignmentForm-" + sel ).find('select').each(function() {
    $( this ).prop( "disabled", false );
  });
  console.log( "chg: " + old + " -> " + sel );
}).change();

$("#assignment_selected").change(function() {
  if ( $( "#assignment_id" ).val() == $( this ).val() ) {
    $( "#operationPanelRefresh" ).hide();
    $( "#operationPanel" ).show();
    console.log( "show assignment handler" );
  } else {
    $( "#operationPanelRefresh" ).show();
    $( "#operationPanel" ).hide();
    console.log( "refresh assignment handler" );
  }
});

$("#search_configure").keyup(function() {
  var pattern = $( this ).val().toUpperCase();
  console.log( "search config: " + pattern );
  $( "#assignment-form-configure" ).find('tr').each(function() {
    if ( $( this ).parent().is("thead") ) {
      return;
    }
    var hide_it = true;
    if (pattern.length > 0) {
      $( this ).find("input[name^='name-old-'").each(function() {
        var name = $( this ).val().toUpperCase();
        if ( name.indexOf(pattern) > -1 ) {
	  hide_it = false;
        }
      });
      $( this ).find("input[name='course'").each(function() {
        var name = $( this ).val().toUpperCase();
        if ( name.indexOf(pattern) > -1 ) {
	  hide_it = false;
        }
      });
    } else {
      hide_it = false;
    }
    if (hide_it) {
      $( this ).hide();
    } else {
      $( this ).show();
    }
  });
});

$("#search_student").keyup(function() {
  var pattern = $( this ).val().toUpperCase();
  console.log( "search student: " + pattern );
  $( "#assignment-form-individual" ).find('tr').each(function() {
    if ( $( this ).parent().is("thead") ) {
      return;
    }
    var hide_it = true;
    if (pattern.length > 0) {
      $( this ).find("input[name='search_student'").each(function() {
        var name = $( this ).val().toUpperCase();
        if ( name.indexOf(pattern) > -1 ) {
	  hide_it = false;
        }
      });
    } else {
      hide_it = false;
    }
    if (hide_it) {
      $( this ).hide();
    } else {
      $( this ).show();
    }
  });
});
</script>

{% endblock %}
